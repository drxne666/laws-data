name: Discord Notification

on:
  push:
    paths:
      - 'rules.json'
      - 'db.json'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # –ù—É–∂–Ω–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

      - name: Get changed files and commit info
        id: vars
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          FILES=$(git diff --name-only HEAD^ HEAD)
          MSG=$(git log -1 --pretty=%s)
          AUTHOR=$(git log -1 --pretty=%an)
          
          if [[ $FILES == *"rules.json"* && $FILES == *"db.json"* ]]; then
            echo "type=üìú –ü–†–ê–í–ò–õ–ê –ò ‚öñÔ∏è –ó–ê–ö–û–ù–´" >> $GITHUB_OUTPUT
          elif [[ $FILES == *"rules.json"* ]]; then
            echo "type=üìú –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ê–í–ò–õ" >> $GITHUB_OUTPUT
          else
            echo "type=‚öñÔ∏è –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–ö–û–ù–û–í" >> $GITHUB_OUTPUT
          fi
          
          echo "commit_msg=$MSG" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

      - name: Send Webhook
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "username": "Las Vegas Helper | System",
                 "avatar_url": "https://i.imgur.com/83p738D.png", 
                 "embeds": [{
                   "title": "${{ steps.vars.outputs.type }}",
                   "description": "–í –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –ø—Ä–∞–≤–∫–∏.",
                   "color": 15814746,
                   "fields": [
                     {
                       "name": "üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é",
                       "value": "```${{ steps.vars.outputs.commit_msg }}```",
                       "inline": false
                     },
                     {
                       "name": "üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
                       "value": "${{ steps.vars.outputs.author }}",
                       "inline": true
                     },
                     {
                       "name": "üöÄ –°—Ç–∞—Ç—É—Å",
                       "value": "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ",
                       "inline": true
                     }
                   ],
                   "footer": {
                     "text": "Las Vegas Helper ‚Ä¢ v0.0.0 ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
                   },
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
